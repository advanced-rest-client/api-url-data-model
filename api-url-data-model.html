<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../raml-aware/raml-aware.html">
<link rel="import" href="../api-view-model-transformer/api-view-model-transformer.html">

<dom-module id="api-url-data-model">
  <template>
    <style>:host {display: none;}</style>
    <template is="dom-if" if="[[aware]]">
      <raml-aware raml="{{webApi}}" scope="[[aware]]"></raml-aware>
    </template>
    <api-view-model-transformer id="transformer"></api-view-model-transformer>
  </template>
  <script>
    /**
     * `api-url-data-model`
     * An element to generate view model for api-url-editor and api-url-params-editor elements from AMF model
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class ApiUrlDataModel extends Polymer.Element {
      static get is() { return 'api-url-data-model'; }
      static get properties() {
        return {
          /**
           * A web API model generated by the AMF.
           * This property is required to compyte parameters properly.
           */
          webApi: {
            type: String,
            observer: '_webApiChanged'
          },
          /**
           * Name of the scope to use with `raml-aware`.
           * If this element is used with other aware elements, it updates
           * `webApi` when aware value change.
           */
          aware: String,
          /**
           * The `@id` property of selected endpoint and method to compute
           * data models for.
           */
          selected: String,
          /**
           * Computed view model for API uri parameters.
           */
          apiParameters: {
            type: Array,
            readOnly: true,
            notify: true
          },
          /**
           * Computed value of API base URI.
           */
          apiBaseUri: {
            type: String,
            readOnly: true,
            notify: true
          }
        };
      }
      /**
       * Clears computed base values of the API.
       */
      _resetBaseValues() {
        this._setApiBaseUri(undefined);
        this._setApiParameters(undefined);
      }
      /**
       * Computes basic properties when model change.
       * @param {Object} model The document model
       */
      _webApiChanged(model) {
        this._resetBaseValues();
        if (model instanceof Array) {
          model = model[0];
        }
        if (!this._modelHasType(model, 'http://raml.org/vocabularies/document#Document')) {
          return;
        }
        const encodes = model['http://raml.org/vocabularies/document#encodes'];
        model = encodes.find((item) => this._modelHasType(item, 'http://schema.org/WebAPI'));
        if (!model) {
          return;
        }
        this._computeApiUriParams(model);
        this._computeApiBaseUri(model);
      }
      /**
       * Computes `apiBaseUri` property when `amfModel` change.
       *
       * @param {Object} model The `http://schema.org/WebAPI` model
       */
      _computeApiBaseUri(model) {
        const prefix = 'http://raml.org/vocabularies/http#';
        let scheme = this._getAmfValue(model[prefix + 'scheme']);
        const host = this._getAmfValue(model[prefix + 'host']);
        const basePath = this._getAmfValue(model[prefix + 'basePath']);
        if (host && !scheme) {
          scheme = 'http';
        }
        if (!scheme || !host) {
          return;
        }
        let result = scheme + '://' + host;
        if (basePath) {
          result += basePath;
        }
        const len = result.length - 1;
        if (result[len] === '/') {
          result = result.substr(0, len);
        }
        this._setApiBaseUri(result);
      }
      /**
       * Computes uri paramerters lsit for API base
       * @param {Object} model The `http://schema.org/WebAPI` model
       */
      _computeApiUriParams(model) {
        const prefix = 'http://raml.org/vocabularies/http#';
        let params = model[prefix + 'parameter'];
        if (!params) {
          return;
        }
        return this.$.transformer
        .computeViewModel(params)
        .then((data) => this._setApiParameters(data));
      }

      /**
       * Checks if a model has a type.
       * @param {Object} model Model to test
       * @param {String} type Type name
       * @return {Boolean} True if model has a type.
       */
      _modelHasType(model, type) {
        const types = model['@type'] || [];
        const index = types.findIndex((item) => item === type);
        return index !== -1;
      }

      /**
       * @param {Object} model Amf model
       * @return {String|undefined} Value for the model.
       */
      _getAmfValue(model) {
        if (!model || !(model instanceof Array)) {
          return;
        }
        model = model[0];
        return model['@value'];
      }
    }

    window.customElements.define(ApiUrlDataModel.is, ApiUrlDataModel);
  </script>
</dom-module>
